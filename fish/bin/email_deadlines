#!/usr/bin/env ruby

require "mail"
require "yaml"

email = YAML.load_file(File.join(__dir__, "email.yml"))["uthman"]
me = email["address"]
password = email["password"]

options = {
  address:              "smtp.gmail.com",
  port:                 587,
  user_name:            me,
  password:             password,
  authentication:       "plain",
  enable_starttls_auto: true
}

Mail.defaults do
  delivery_method :smtp, options
end

deadlines = `deadlines`

def internet?
  require "resolv"
  dns_resolver = Resolv::DNS.new
  begin
    dns_resolver.getaddress("symbolics.com")
    true
  rescue Resolv::ResolvError => e
    false
  end
end

sleep 30 until internet?

Mail.deliver do
  to me
  from password
  subject "Deadlines"
  body deadlines
end
